from rest_framework import viewsets, permissions
from .models import Review
from .serializers import ReviewSerializer
from rest_framework.permissions import IsAuthenticated
from rest_framework.pagination import PageNumberPagination
from rest_framework.response import Response
import math
from rest_framework import generics
from django_filters.rest_framework import DjangoFilterBackend
from django.db.models import Q
from django.core.paginator import Paginator
from rest_framework import status
from transformers import pipeline
from bookings.models import ServiceType
from hotels.models import Hotel, UserHotelInteraction
from activities.models import Activity, UserActivityInteraction
from django.db.models import Avg, Count
from django.db import transaction

# Kh·ªüi t·∫°o m√¥ h√¨nh sentiment-analysis ch·ªâ m·ªôt l·∫ßn
_model_path = "5CD-AI/Vietnamese-Sentiment-visobert"
_sentiment_analyzer = pipeline(
    "sentiment-analysis", model=_model_path, tokenizer=_model_path
)


# Ph√¢n trang
class ReviewPagination(PageNumberPagination):
    page_size = 10  # Default value
    currentPage = 1
    filters = {}

    def get_page_size(self, request):
        # L·∫•y gi√° tr·ªã pageSize t·ª´ query string, n·∫øu c√≥
        page_size = request.query_params.get("pageSize")
        currentPage = request.query_params.get("current")
        service_type = request.query_params.get("service_type")
        service_ref_id = request.query_params.get("service_ref_id")

        if service_type:
            self.filters["service_type"] = service_type

        if service_ref_id:
            self.filters["service_ref_id"] = service_ref_id

        for field, value in request.query_params.items():
            if field not in ["current", "pageSize", "service_type", "service_ref_id"]:
                # c√≥ th·ªÉ d√πng __icontains n·∫øu mu·ªën LIKE, ho·∫∑c ƒë·ªÉ nguy√™n n·∫øu so s√°nh b·∫±ng
                self.filters[f"{field}__icontains"] = value

        # N·∫øu kh√¥ng c√≥ ho·∫∑c gi√° tr·ªã kh√¥ng h·ª£p l·ªá, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh
        try:
            self.page_size = int(page_size) if page_size is not None else self.page_size
        except (ValueError, TypeError):
            self.page_size = self.page_size

        try:
            self.currentPage = (
                int(currentPage) if currentPage is not None else self.currentPage
            )
        except (ValueError, TypeError):
            self.currentPage = self.currentPage

        return self.page_size

    def get_paginated_response(self, data):

        total_count = Review.objects.filter(**self.filters).count()
        total_pages = math.ceil(total_count / self.page_size)

        self.filters.clear()

        return Response(
            {
                "isSuccess": True,
                "message": "Fetched reviews successfully!",
                "meta": {
                    "totalItems": total_count,
                    "currentPage": self.currentPage,
                    "itemsPerPage": self.page_size,
                    "totalPages": total_pages,
                },
                "data": data,
            }
        )


# API GET danh s√°ch th√†nh ph·ªë (v·ªõi ph√¢n trang)
class ReviewListView(generics.ListAPIView):
    queryset = Review.objects.all().order_by("-created_at")
    serializer_class = ReviewSerializer
    pagination_class = ReviewPagination
    authentication_classes = []  # ‚úÖ c·∫ßn c√≥ ƒë·ªÉ l·∫•y user
    permission_classes = []  # Kh√¥ng c·∫ßn ki·ªÉm tra quy·ªÅn
    filter_backends = [DjangoFilterBackend]

    def get_queryset(self):
        queryset = Review.objects.all().order_by("-created_at")

        # L·ªçc d·ªØ li·ªáu theo query params
        filter_params = self.request.query_params
        query_filter = Q()

        # l·ªçc theo service_type (service_type l√† FK trong model Hotel)
        service_type = filter_params.get("service_type")
        if service_type:
            query_filter &= Q(service_type=service_type)

        service_ref_id = filter_params.get("service_ref_id")
        if service_ref_id:
            query_filter &= Q(service_ref_id=service_ref_id)

        for field, value in filter_params.items():
            if field not in [
                "pageSize",
                "current",
                "service_type",
                "service_ref_id",
            ]:  # B·ªè qua c√°c tr∆∞·ªùng ph√¢n trang
                query_filter &= Q(**{f"{field}__icontains": value})

        # √Åp d·ª•ng l·ªçc cho queryset
        queryset = queryset.filter(query_filter)

        # L·∫•y tham s·ªë 'current' t·ª´ query string ƒë·ªÉ t√≠nh to√°n trang
        current = self.request.query_params.get(
            "current", 1
        )  # Trang hi·ªán t·∫°i, m·∫∑c ƒë·ªãnh l√† trang 1
        page_size = self.request.query_params.get(
            "pageSize", 10
        )  # S·ªë ph·∫ßn t·ª≠ m·ªói trang, m·∫∑c ƒë·ªãnh l√† 10

        # √Åp d·ª•ng ph√¢n trang
        paginator = Paginator(queryset, page_size)
        page = paginator.get_page(current)

        return page


class ReviewCreateView(generics.CreateAPIView):
    queryset = Review.objects.all().order_by("-created_at")
    serializer_class = ReviewSerializer
    permission_classes = [IsAuthenticated]

    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        review = serializer.save(user=request.user)

        # N·∫øu c√≥ comment th√¨ ph√¢n t√≠ch c·∫£m x√∫c
        if review.comment and review.comment.strip():
            result = _sentiment_analyzer(review.comment)[0]
            label = result["label"]
            score = float(result["score"])

            # Map nh√£n model sang d·∫°ng b·∫°n mu·ªën l∆∞u
            if label == "POS":
                sentiment = "positive"
            elif label == "NEG":
                sentiment = "negative"
            else:
                sentiment = "neutral"

            # G√°n v√†o b·∫£n ghi review
            review.sentiment = sentiment
            review.confidence = score
            review.save(update_fields=["sentiment", "confidence"])

        # =========================
        # üîπ C·∫¨P NH·∫¨T TH·ªêNG K√ä
        # =========================
        service_type = getattr(review, "service_type", None)
        service_ref_id = getattr(review, "service_ref_id", None)

        if not service_type or not service_ref_id:
            return Response(
                {"isSuccess": False, "message": "Invalid service type or ref id"},
                status=status.HTTP_400_BAD_REQUEST,
            )

        # H√†m ph·ª• ƒë·ªÉ c·∫≠p nh·∫≠t th·ªëng k√™
        def update_service_stats(model, type_value):
            instance = model.objects.filter(id=service_ref_id).first()
            if not instance:
                return

            reviews = Review.objects.filter(
                service_type=type_value, service_ref_id=instance.id
            )

            # T·ªïng h·ª£p d·ªØ li·ªáu
            stats = reviews.aggregate(
                avg_star=Avg("rating"),
                review_count=Count("id"),
                total_positive=Count("id", filter=Q(sentiment="positive")),
                total_negative=Count("id", filter=Q(sentiment="negative")),
                total_neutral=Count("id", filter=Q(sentiment="neutral")),
            )

            # C·∫≠p nh·∫≠t gi√° tr·ªã v√†o model
            instance.avg_star = stats["avg_star"] or 0
            instance.review_count = stats["review_count"] or 0
            instance.total_positive = stats["total_positive"] or 0
            instance.total_negative = stats["total_negative"] or 0
            instance.total_neutral = stats["total_neutral"] or 0

            instance.save(
                update_fields=[
                    "avg_star",
                    "review_count",
                    "total_positive",
                    "total_negative",
                    "total_neutral",
                ]
            )

            # ‚úÖ T·ª± ƒë·ªông c·∫≠p nh·∫≠t weighted_score
            instance.update_total_weighted_score()
            return instance

        # =========================
        # üîπ G·ªåI C·∫¨P NH·∫¨T T∆Ø∆†NG ·ª®NG
        # =========================
        if service_type == ServiceType.HOTEL:
            hotel = update_service_stats(Hotel, ServiceType.HOTEL)

            # ‚úÖ C·∫≠p nh·∫≠t ho·∫∑c t·∫°o UserHotelInteraction t∆∞∆°ng ·ª©ng
            if hotel:
                interaction, _ = UserHotelInteraction.objects.get_or_create(
                    user=request.user, hotel=hotel
                )

                if review.sentiment == "positive":
                    interaction.positive_count += 1
                elif review.sentiment == "negative":
                    interaction.negative_count += 1
                else:
                    interaction.neutral_count += 1

                # C·∫≠p nh·∫≠t ƒëi·ªÉm tr·ªçng s·ªë c√° nh√¢n
                interaction.update_weighted_score()
                interaction.save()
        elif service_type == ServiceType.ACTIVITY:
            activity = update_service_stats(Activity, ServiceType.ACTIVITY)

            # ‚úÖ C·∫≠p nh·∫≠t ho·∫∑c t·∫°o UserActivityInteraction t∆∞∆°ng ·ª©ng
            if activity:
                interaction, _ = UserActivityInteraction.objects.get_or_create(
                    user=request.user, activity=activity
                )

                if review.sentiment == "positive":
                    interaction.positive_count += 1
                elif review.sentiment == "negative":
                    interaction.negative_count += 1
                else:
                    interaction.neutral_count += 1

                # C·∫≠p nh·∫≠t ƒëi·ªÉm tr·ªçng s·ªë c√° nh√¢n
                interaction.update_weighted_score()
                interaction.save()

        # =========================
        # üîπ TR·∫¢ V·ªÄ K·∫æT QU·∫¢
        # =========================
        return Response(
            {
                "isSuccess": True,
                "message": "Review created successfully",
                "data": ReviewSerializer(
                    review, context=self.get_serializer_context()
                ).data,
            },
            status=status.HTTP_200_OK,
        )


class ReviewDetailView(generics.RetrieveUpdateDestroyAPIView):
    queryset = Review.objects.all().order_by("-created_at")
    serializer_class = ReviewSerializer
    authentication_classes = []  # B·ªè qua t·∫•t c·∫£ c√°c l·ªõp x√°c th·ª±c
    permission_classes = []  # Kh√¥ng c·∫ßn ki·ªÉm tra quy·ªÅn

    def retrieve(self, request, *args, **kwargs):
        """
        Override ph∆∞∆°ng th·ª©c `retrieve` ƒë·ªÉ tr·∫£ v·ªÅ response chu·∫©n cho vi·ªác l·∫•y th√¥ng tin chi ti·∫øt review.
        """
        instance = self.get_object()
        serializer = self.get_serializer(instance)

        return Response(
            {
                "isSuccess": True,
                "message": "Review details fetched successfully",
                "data": serializer.data,  # D·ªØ li·ªáu review
            }
        )


class ReviewUpdateView(generics.UpdateAPIView):
    queryset = Review.objects.all().order_by("-created_at")
    serializer_class = ReviewSerializer
    permission_classes = [IsAuthenticated]

    # =========================
    # üîπ H√†m ph·ª• c·∫≠p nh·∫≠t th·ªëng k√™
    # =========================
    def update_service_stats(self, model, type_value, ref_id):
        instance = model.objects.filter(id=ref_id).first()
        if not instance:
            return None

        reviews = Review.objects.filter(service_type=type_value, service_ref_id=ref_id)

        stats = reviews.aggregate(
            avg_star=Avg("rating"),
            review_count=Count("id"),
            total_positive=Count("id", filter=Q(sentiment="positive")),
            total_negative=Count("id", filter=Q(sentiment="negative")),
            total_neutral=Count("id", filter=Q(sentiment="neutral")),
        )

        instance.avg_star = stats["avg_star"] or 0
        instance.review_count = stats["review_count"] or 0
        instance.total_positive = stats["total_positive"] or 0
        instance.total_negative = stats["total_negative"] or 0
        instance.total_neutral = stats["total_neutral"] or 0
        instance.save(
            update_fields=[
                "avg_star",
                "review_count",
                "total_positive",
                "total_negative",
                "total_neutral",
            ]
        )

        # ‚úÖ C·∫≠p nh·∫≠t ƒëi·ªÉm tr·ªçng s·ªë t·ªïng th·ªÉ
        instance.update_total_weighted_score()
        return instance

    # =========================
    # üîπ H√†m ph·ª• c·∫≠p nh·∫≠t interaction
    # =========================
    def update_interaction(self, interaction, sentiment):
        interaction.positive_count = Review.objects.filter(
            user=interaction.user,
            sentiment="positive",
            service_ref_id=getattr(
                interaction, "hotel_id", getattr(interaction, "activity_id", None)
            ),
        ).count()

        interaction.negative_count = Review.objects.filter(
            user=interaction.user,
            sentiment="negative",
            service_ref_id=getattr(
                interaction, "hotel_id", getattr(interaction, "activity_id", None)
            ),
        ).count()

        interaction.neutral_count = Review.objects.filter(
            user=interaction.user,
            sentiment="neutral",
            service_ref_id=getattr(
                interaction, "hotel_id", getattr(interaction, "activity_id", None)
            ),
        ).count()

        interaction.update_weighted_score()
        interaction.save()

    # =========================
    # üîπ Update ch√≠nh
    # =========================
    @transaction.atomic
    def update(self, request, *args, **kwargs):
        review = self.get_object()
        serializer = self.get_serializer(review, data=request.data, partial=True)
        serializer.is_valid(raise_exception=True)
        updated_review = serializer.save()

        # =========================
        # üîπ PH√ÇN T√çCH C·∫¢M X√öC M·ªöI
        # =========================
        if updated_review.comment and updated_review.comment.strip():
            result = _sentiment_analyzer(updated_review.comment)[0]
            label = result["label"]
            score = round(float(result["score"]), 4)

            if label == "POS":
                sentiment = "positive"
            elif label == "NEG":
                sentiment = "negative"
            else:
                sentiment = "neutral"

            updated_review.sentiment = sentiment
            updated_review.confidence = score
            updated_review.save(update_fields=["sentiment", "confidence"])

        # =========================
        # üîπ C·∫¨P NH·∫¨T TH·ªêNG K√ä V√Ä INTERACTION
        # =========================
        service_type = getattr(updated_review, "service_type", None)
        ref_id = getattr(updated_review, "service_ref_id", None)

        if service_type == ServiceType.HOTEL:
            hotel = self.update_service_stats(Hotel, ServiceType.HOTEL, ref_id)
            if hotel:
                interaction, _ = UserHotelInteraction.objects.get_or_create(
                    user=request.user, hotel=hotel
                )
                self.update_interaction(interaction, updated_review.sentiment)

        elif service_type == ServiceType.ACTIVITY:
            activity = self.update_service_stats(Activity, ServiceType.ACTIVITY, ref_id)
            if activity:
                interaction, _ = UserActivityInteraction.objects.get_or_create(
                    user=request.user, activity=activity
                )
                self.update_interaction(interaction, updated_review.sentiment)

        # =========================
        # üîπ TR·∫¢ K·∫æT QU·∫¢
        # =========================
        return Response(
            {
                "isSuccess": True,
                "message": "Review updated successfully",
                "data": ReviewSerializer(
                    updated_review, context=self.get_serializer_context()
                ).data,
            },
            status=status.HTTP_200_OK,
        )


class ReviewDeleteView(generics.DestroyAPIView):
    queryset = Review.objects.all().order_by("-created_at")
    serializer_class = ReviewSerializer
    permission_classes = [IsAuthenticated]

    def destroy(self, request, *args, **kwargs):
        instance = self.get_object()
        service_type = instance.service_type
        ref_id = instance.service_ref_id
        user = request.user

        # L∆∞u l·∫°i sentiment tr∆∞·ªõc khi x√≥a ƒë·ªÉ c·∫≠p nh·∫≠t Interaction
        old_sentiment = instance.sentiment

        # X√≥a review
        self.perform_destroy(instance)

        # =========================
        # üîπ H√ÄM C·∫¨P NH·∫¨T TH·ªêNG K√ä
        # =========================
        def update_service_stats(model, type_value, ref_id):
            service = model.objects.filter(id=ref_id).first()
            if not service:
                return None

            reviews = Review.objects.filter(
                service_type=type_value, service_ref_id=ref_id
            )

            stats = reviews.aggregate(
                avg_star=Avg("rating"),
                review_count=Count("id"),
                total_positive=Count("id", filter=Q(sentiment="positive")),
                total_negative=Count("id", filter=Q(sentiment="negative")),
                total_neutral=Count("id", filter=Q(sentiment="neutral")),
            )

            service.avg_star = stats["avg_star"] or 0
            service.review_count = stats["review_count"] or 0
            service.total_positive = stats["total_positive"] or 0
            service.total_negative = stats["total_negative"] or 0
            service.total_neutral = stats["total_neutral"] or 0

            service.save(
                update_fields=[
                    "avg_star",
                    "review_count",
                    "total_positive",
                    "total_negative",
                    "total_neutral",
                ]
            )

            # ‚úÖ C·∫≠p nh·∫≠t l·∫°i total_weighted_score
            service.update_total_weighted_score()
            return service

        # =========================
        # üîπ G·ªåI C·∫¨P NH·∫¨T & C·∫¨P NH·∫¨T INTERACTION
        # =========================
        if service_type == ServiceType.HOTEL:
            hotel = update_service_stats(Hotel, ServiceType.HOTEL, ref_id)

            if hotel:
                interaction = UserHotelInteraction.objects.filter(
                    user=user, hotel=hotel
                ).first()
                if interaction:
                    # Gi·∫£m s·ªë l∆∞·ª£ng sentiment t∆∞∆°ng ·ª©ng
                    if old_sentiment == "positive" and interaction.positive_count > 0:
                        interaction.positive_count -= 1
                    elif old_sentiment == "negative" and interaction.negative_count > 0:
                        interaction.negative_count -= 1
                    elif old_sentiment == "neutral" and interaction.neutral_count > 0:
                        interaction.neutral_count -= 1

                    # C·∫≠p nh·∫≠t l·∫°i ƒëi·ªÉm c√° nh√¢n h√≥a
                    interaction.update_weighted_score()
                    interaction.save()

        elif service_type == ServiceType.ACTIVITY:
            activity = update_service_stats(Activity, ServiceType.ACTIVITY, ref_id)

            if activity:
                interaction = UserActivityInteraction.objects.filter(
                    user=user, activity=activity
                ).first()
                if interaction:
                    # Gi·∫£m s·ªë l∆∞·ª£ng sentiment t∆∞∆°ng ·ª©ng
                    if old_sentiment == "positive" and interaction.positive_count > 0:
                        interaction.positive_count -= 1
                    elif old_sentiment == "negative" and interaction.negative_count > 0:
                        interaction.negative_count -= 1
                    elif old_sentiment == "neutral" and interaction.neutral_count > 0:
                        interaction.neutral_count -= 1

                    # C·∫≠p nh·∫≠t l·∫°i ƒëi·ªÉm c√° nh√¢n h√≥a
                    interaction.update_weighted_score()
                    interaction.save()

        # =========================
        # üîπ TR·∫¢ K·∫æT QU·∫¢
        # =========================
        return Response(
            {
                "isSuccess": True,
                "message": "Review deleted successfully",
                "data": {},
            },
            status=status.HTTP_200_OK,
        )
